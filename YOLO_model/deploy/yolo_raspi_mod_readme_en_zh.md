# 垃圾分类检测系统

## 项目简介

本项目实现了一个基于YOLO深度学习模型的垃圾分类检测系统。系统通过摄像头实时捕捉图像，使用YOLO模型进行物体检测和分类，并通过串口与STM32微控制器及串口显示屏进行通信，实时显示检测结果和分类信息。

## 功能特性

- **实时视频捕捉**：使用OpenCV从摄像头获取实时视频流。
- **物体检测与分类**：基于YOLO模型进行高精度的物体检测和垃圾分类。
- **串口通信**：与STM32微控制器和串口显示屏进行双向通信，实现数据的发送与接收。
- **多分类支持**：支持将垃圾分类为厨余垃圾、可回收垃圾、有害垃圾和其他垃圾。
- **调试窗口**：可选的调试窗口，显示检测结果和实时视频流。

## 环境依赖

### 硬件需求

- **摄像头**：支持的摄像头设备，如USB摄像头。
- **STM32微控制器**：用于与系统进行串口通信。
- **串口显示屏**：用于显示分类结果。

### 软件需求

- **操作系统**：Linux（如Raspberry Pi OS），也可在其他支持串口通信的系统上运行。
- **Python 3.7+**

### Python库依赖

- `opencv-python`
- `torch`
- `ultralytics`
- `numpy`
- `pyserial`

### 安装依赖

建议使用`pip`进行安装：

```bash
pip install opencv-python torch ultralytics numpy pyserial
```

## 安装指南

1. **安装Python依赖**

    ```bash
    pip install -r requirements.txt
    ```

2. **准备YOLO模型**

    将训练好的YOLO模型文件（如`best.pt`）放置在项目根目录下，或根据需要修改代码中的模型路径。

3. **配置串口**

    根据实际硬件连接，修改代码中的串口配置参数：

    ```python
    STM32_PORT = '/dev/ttyS0'  # STM32串口
    STM32_BAUD = 115200
    SCREEN_PORT = '/dev/ttyAMA2'  # 串口屏
    SCREEN_BAUD = 9600
    ```

## 使用方法

运行主程序：

```bash
python your_script.py
```

运行后，系统将执行以下步骤：

1. **初始化GPU**：检测是否有可用的GPU，加速模型推理。
2. **初始化串口**：尝试连接STM32和串口显示屏。
3. **启动摄像头**：查找并打开可用的摄像头设备。
4. **实时检测**：从摄像头读取帧，进行物体检测和分类，并通过串口发送结果。
5. **调试窗口**（可选）：如果启用调试窗口，将显示带有检测结果的实时视频流。

按 `q` 键可退出程序。

## 串口配置说明

- **STM32串口**：用于接收分类结果，连接到STM32的TX/RX引脚。请确保波特率和端口号正确配置。
- **串口显示屏**：用于显示分类信息，连接到串口屏的TX/RX引脚。默认使用GB2312编码发送中文信息。

### 配置参数

在代码中，可以通过修改以下变量来调整串口配置：

```python
STM32_PORT = '/dev/ttyS0'  # STM32串口
STM32_BAUD = 115200
SCREEN_PORT = '/dev/ttyAMA2'  # 串口屏
SCREEN_BAUD = 9600
```

## 模块说明

### `SerialManager` 类

负责管理与STM32和串口显示屏的串口通信，包括数据的发送与接收。

- **初始化串口**：尝试打开STM32和串口屏的串口连接。
- **发送数据到STM32**：根据分类结果发送对应的分类ID。
- **发送数据到串口屏**：将分类信息以指定编码发送到串口屏。
- **接收STM32数据**：在后台线程中持续接收来自STM32的数据。

### `WasteClassifier` 类

负责将细分类别映射到大分类，并提供分类信息。

- **`get_category_info`**：根据类别ID获取详细分类信息。
- **`print_classification`**：打印分类信息。

### `YOLODetector` 类

负责加载YOLO模型并进行物体检测和分类。

- **初始化模型**：加载YOLO模型，并设置设备（GPU或CPU）。
- **`detect` 方法**：对输入帧进行检测，绘制检测结果（可选），并发送分类信息到串口。

### 主函数 `main`

- **GPU检测**：检查是否有可用的GPU。
- **初始化检测器和串口管理器**。
- **启动摄像头并进入检测循环**。
- **处理键盘中断，清理资源**。

## 配置选项

在代码开头，可以通过修改以下全局变量来调整系统行为：

```python
DEBUG_WINDOW = False  # 是否启用调试窗口
ENABLE_SERIAL = True  # 是否启用串口通信
CONF_THRESHOLD = 0.9  # 检测置信度阈值
```

- **`DEBUG_WINDOW`**：开启后，将显示带有检测结果的实时视频窗口。
- **`ENABLE_SERIAL`**：开启后，将启用与STM32和串口屏的串口通信。
- **`CONF_THRESHOLD`**：设置检测的置信度阈值，只有高于该阈值的检测结果才会被处理。

## 注意事项

- **串口权限**：运行程序的用户需要有访问串口设备的权限，必要时可以使用`sudo`运行程序或调整设备权限。
- **模型兼容性**：确保使用的YOLO模型与代码兼容，类别名称和ID需对应正确。
- **编码设置**：串口屏默认使用GB2312编码发送中文信息，确保接收端能够正确解码。
- **资源释放**：程序退出时会自动关闭串口和摄像头，确保系统资源得到正确释放。

## 常见问题

### 未检测到GPU

如果系统未检测到GPU，程序将自动切换到CPU进行推理。可以通过修改代码或硬件配置来启用GPU加速。

### 无法连接串口设备

请检查串口设备是否正确连接，并确认端口号和波特率设置是否正确。确保运行程序的用户有权限访问相应的串口设备。

### 摄像头无法启动

请确保摄像头已正确连接，并且驱动安装完毕。可以使用其他应用程序（如`cheese`）测试摄像头是否正常工作。

## 许可证

本项目采用MIT许可证，详细信息请参见[LICENSE](LICENSE)。

## 致谢

感谢所有开源项目和库的贡献者，特别是YOLO和Ultralytics团队，为本项目提供了强大的支持。

# 贡献

欢迎任何形式的贡献！请提交Issue或Pull Request以分享您的改进和建议。

# 联系我们

如有任何问题或建议，请联系 [your-email@example.com](mailto:your-email@example.com)。

# 示例

![系统架构图](path/to/your/image.png)

*注意：图片仅供参考，实际系统可能有所不同。*

# 结束语

感谢您使用本垃圾分类检测系统！希望它能为您的项目带来帮助。

# License

MIT License. See [LICENSE](LICENSE) for more information.

# 参考资料

- [YOLOv8官方文档](https://docs.ultralytics.com/)
- [PySerial文档](https://pyserial.readthedocs.io/)
- [OpenCV文档](https://docs.opencv.org/)
