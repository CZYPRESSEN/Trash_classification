# 树莓派 YOLOv8 目标检测系统

这是一个基于树莓派的实时目标检测系统，使用 YOLOv8 模型进行检测，并集成了 STM32 串口通信和串口显示屏功能。

## 主要功能

- 基于 YOLOv8 的实时目标检测
- GPU 加速支持（如果可用）
- 双串口通信系统：
  - STM32 微控制器接口
  - 串口显示屏输出
- 实时视频显示（可选调试窗口）
- 支持11种物体类别检测
- 可配置的置信度阈值
- 自动相机检测功能

## 系统要求

### 硬件要求

- 树莓派（配备摄像头模块）
- STM32 微控制器（通过 UART 连接）
- 串口显示屏
- GPU（可选，用于加速）

### 软件依赖

```bash
pip install torch
pip install ultralytics
pip install opencv-python
pip install pyserial
```

## 系统配置

### 串口设置

- STM32 通信配置：
  - 端口：`/dev/ttyS0`
  - 波特率：9600
  - 协议：自定义帧格式（带帧头和帧尾）

- 显示屏配置：
  - 端口：`/dev/ttyUSB0`
  - 波特率：115200
  - 编码方式：GB2312

### 全局参数

```python
DEBUG_WINDOW = True     # 是否启用调试窗口
ENABLE_SERIAL = True    # 是否启用串口通信
CONF_THRESHOLD = 0.5    # 检测置信度阈值
```

## 检测类别

系统可以检测以下物体：

1. 土豆 (0)
2. 白萝卜 (1)
3. 胡萝卜 (2)
4. 瓶子 (3)
5. 罐头 (4)
6. 电池 (5)
7. 药品 (6)
8. 内包装 (7)
9. 瓷砖 (8)
10. 石头 (9)
11. 砖块 (10)

## 通信协议

### STM32 通信协议

- 帧格式：`[FF FF] [数据] [FF FF]`
- 数据：单字节表示检测到的类别ID
- 支持双向通信

### 显示屏通信协议

- 命令格式：`t0.txt="[文本]"[FF FF FF]`
- 文本编码：GB2312
- 单向通信（仅输出）

## 使用方法

1. 连接硬件设备（摄像头、STM32、显示屏）
2. 确认串口配置与实际设置相符
3. 将训练好的 YOLOv8 模型文件（`best.pt`）放在项目目录下
4. 运行程序：

```bash
python yolo_raspi_mod.py
```

### 运行时控制

- 在调试窗口模式下，按 'q' 键退出程序
- 使用 Ctrl+C 从终端终止程序

## 程序流程

1. 系统初始化：
   - GPU 检测与设置
   - 串口初始化
   - 相机检测
   - 模型加载

2. 主循环：
   - 从相机捕获画面
   - 使用 YOLOv8 进行目标检测
   - 结果可视化（如果启用调试）
   - 通过串口发送结果
   - 更新显示屏内容

## 错误处理

系统包含以下方面的错误处理：
- 相机初始化失败处理
- 串口通信错误处理
- GPU 可用性检查
- 画面捕获异常处理
- 模型加载问题处理

## 调试功能

当启用 `DEBUG_WINDOW` 时：
- 实时视频流显示检测框
- 显示置信度分数
- 类别颜色编码显示
- 可调整窗口大小（默认 800x600）

## 性能考虑

- 自动使用 GPU 加速（如果可用）
- 使用线程处理串口通信，防止 I/O 阻塞
- 串口通信的缓冲区管理
- 可配置的置信度阈值用于过滤检测结果

## 代码贡献

欢迎提交问题和改进建议！

## 致谢

- YOLOv8 by Ultralytics
- OpenCV 社区
- PySerial 开发者
